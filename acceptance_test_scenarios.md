# 受け入れテストシナリオ（Playwright E2Eテスト用）

## 1. テスト概要

### 1.1 テスト目的
競合企業ニュース自動収集・分析システムの主要機能が要件通りに動作することを確認する。

### 1.2 テスト対象
- Web管理画面（企業管理・テスト実行機能）
- Slack配信機能
- 情報収集・分析機能

### 1.3 テスト環境
- **開発環境**: ステージング環境
- **Slack**: テスト用ワークスペース・チャンネル
- **データ**: テスト用企業データ・モックニュース

## 2. 最重要テストシナリオ

### シナリオ1: 企業登録・基本設定

#### **前提条件**
- Web管理画面にアクセス可能
- Slack認証が完了している

#### **テスト手順**
1. **Slack認証でログイン**
   - Web管理画面にアクセス
   - Slack OAuth認証を実行
   - 認証成功後、管理画面トップページが表示される

2. **企業情報登録（DOPA競合企業）**
   - 「企業管理」メニューをクリック
   - 以下のDOPA競合企業を順次登録：
   
   **企業1: The Pokémon Company International**
   - 「新規企業登録」ボタンをクリック
   - 企業名: "The Pokémon Company International"
   - 企業公式URL: "https://www.pokemon.com"
   - RSS URL: "https://www.pokemon.com/us/pokemon-news/rss/"
   - 「登録」ボタンをクリック
   
   **企業2: DeNA Co., Ltd.**
   - 「新規企業登録」ボタンをクリック
   - 企業名: "DeNA Co., Ltd."
   - 企業公式URL: "https://dena.com"
   - RSS URL: "https://dena.com/intl/news/"
   - 「登録」ボタンをクリック
   
   **企業3: Niantic, Inc.**
   - 「新規企業登録」ボタンをクリック
   - 企業名: "Niantic, Inc."
   - 企業公式URL: "https://nianticlabs.com"
   - RSS URL: "https://nianticlabs.com/blog/"
   - 「登録」ボタンをクリック
   
   - 企業一覧に3社が表示される

3. **情報収集コンテキスト登録（DOPA向け）**
   - 「設定」メニューをクリック
   - 「情報収集コンテキスト」を選択
   - テキスト欄に以下を入力：
     ```
    デジタルカード・NFTプラットフォーム競合の動向を把握し、
    自社（DOPA）の戦略立案に活用するため、
    新プラットフォーム発表、パートナーシップ、技術革新、
    ユーザー数・売上実績、規制対応、NFT市場動向を重視する。
    個人情報やプライベートな投稿は除外する。
     ```
   - 「保存」ボタンをクリック

4. **Slack配信チャンネル設定**
   - 「設定」メニューをクリック
   - 「Slack配信設定」を選択
   - チャンネル一覧が表示される
   - 対象チャンネル（例: #competitor-news）を選択
   - 「設定」ボタンをクリック

5. **エラー通知ユーザー設定**
   - 「設定」メニューをクリック
   - 「エラー通知設定」を選択
   - 通知対象ユーザーを設定
   - 「保存」ボタンをクリック

#### **期待結果**
- 企業が正常に登録される
- 情報収集コンテキストが保存される
- Slack配信チャンネルが設定される
- エラー通知設定が保存される
- 管理画面に適切なメッセージが表示される

---

### シナリオ2: テスト実行機能

#### **前提条件**
- シナリオ1が完了している
- The Pokémon Company International、DeNA Co., Ltd.、Niantic, Inc.が登録済み

#### **テスト手順**
1. **情報取得テスト（全企業対象）**
   - 「テスト実行」メニューをクリック
   - 「全企業情報取得テスト」ボタンをクリック
   - テスト実行中のローディング表示を確認
   - 3社分のテスト結果が表示される

2. **日次レポートテスト（全企業対象）**
   - 「テスト実行」メニューをクリック
   - 「日次レポートテスト（全企業）」を選択
   - テスト実行ボタンをクリック
   - Slackチャンネルで3社分のニュースを含む日次レポートが受信される

3. **週次レポートテスト（全企業対象）**
   - 「テスト実行」メニューをクリック
   - 「週次レポートテスト（全企業）」を選択
   - テスト実行ボタンをクリック
   - Slackチャンネルで3社分の戦略分析を含む週次レポートが受信される

#### **期待結果**
- 3社全ての情報取得が正常に実行される
- 3社分のニュースデータが表示される
- **バックエンド処理確認**：
  - 記事の重複が適切に排除されている（同じ内容の記事が統合されている）
  - 記事タイトル・内容が日本語に翻訳されている
  - 記事が適切に要約されている（200文字以内のサマリ）
  - 重要度が100点満点で評価されている
  - 統合された記事には複数のソース元リンクが保持されている
- 3社分のニュースを含む日次レポートがSlackチャンネルに配信される
- 3社分の戦略分析を含む週次レポートがSlackチャンネルに配信される
- エラー時は設定したユーザーにメンションが送信される

---

### シナリオ3: 日次レポート配信確認

#### **前提条件**
- シナリオ2の日次レポートテストが完了している

#### **テスト手順**
1. **Slack配信内容確認**
   - テスト用Slackチャンネルを確認
   - 本文投稿が受信される：
     ```
     📊 競合情報レポート (X件)
     ```
   - スレッド投稿が受信される：
     ```
     1. <URL|【企業名】見出し - 要約>
     2. <URL|【企業名】見出し - 要約>
     ...
     ```

#### **期待結果**
- **本文投稿確認**：
  - 件数表示が含まれる（例：「📊 競合情報レポート (45件)」）
  - 重要度上位10件のリンク付きテキストが表示される
  - リンクが正常に動作する
  - 重要度スコアは表示されない（内部処理のみ）
- **スレッド投稿確認**：
  - その他のニュースがリンク付きテキストで表示される
  - 統合された記事には複数のソース元リンクが含まれる
  - 全てのニュースが重要度順で表示される
- **バックエンド処理確認**：
  - 記事の重複が適切に排除されている
  - 日本語翻訳が正しく適用されている
  - 適切な要約が生成されている

---

### シナリオ4: 週次レポート配信確認

#### **前提条件**
- シナリオ2の週次レポートテストが完了している

#### **テスト手順**
1. **Slack配信内容確認**
   - テスト用Slackチャンネルを確認
   - 週次レポートが受信される：
     ```
     📈 週次戦略分析レポート (第X週)
     
     🏢 [企業A]
     • 基本戦略: [戦略概要]
     • 変更点: [今週の変更]
     • ニュースサマリ: [週間ハイライト]
     ```

#### **期待結果**
- **配信内容確認**：
  - 各企業の戦略分析が日本語で配信される
  - 戦略変更点が抽出される
  - 週間ニュースサマリが含まれる
  - 競合比較分析が含まれる
- **バックエンド処理確認**：
  - 戦略分析が適切に日本語翻訳されている
  - 週間データの統合・重複排除が正しく実行されている
  - 戦略変更の検出が正確に行われている

---

### シナリオ5: エラーハンドリング

#### **前提条件**
- 正常な企業登録が完了している

#### **テスト手順**
1. **無効なURLでの企業登録**
   - 企業登録画面で無効なURL（例: "invalid-url"）を入力
   - 登録ボタンをクリック
   - 「無効なURL形式です」エラーメッセージが表示される

2. **必須項目未入力での企業登録**
   - 企業名を空のまま登録ボタンをクリック
   - 「企業名は必須項目です」エラーメッセージが表示される

3. **Slack認証エラー**
   - 無効なSlackトークンでアクセス
   - 「Slack認証に失敗しました」エラーメッセージが表示される

4. **Slack配信エラー**
   - 存在しないSlackチャンネル（例: #non-existent-channel）を設定
   - 配信テストを実行
   - 「Slack配信に失敗しました」エラーメッセージが表示される
   - エラー通知が設定ユーザーにメンション付きで送信される
   - Slackチャンネルでエラー通知メッセージを確認

5. **LLM処理エラー**
   - 無効なニュースデータ（空のコンテンツ）で処理実行
   - 「LLM処理に失敗しました」エラーメッセージが表示される
   - エラー通知が設定ユーザーにメンション付きで送信される
   - Slackチャンネルでエラー通知メッセージを確認

6. **外部API接続エラー**
   - ネットワーク接続を切断した状態で情報取得テストを実行
   - 「外部API接続に失敗しました」エラーメッセージが表示される
   - エラー通知が設定ユーザーにメンション付きで送信される
   - Slackチャンネルでエラー通知メッセージを確認

7. **データベース接続エラー**
   - Firestore接続エラーをシミュレート
   - 「データベース接続に失敗しました」エラーメッセージが表示される
   - エラー通知が設定ユーザーにメンション付きで送信される
   - Slackチャンネルでエラー通知メッセージを確認

#### **期待結果**
- **エラー処理確認**：
  - 各エラーケースで適切なエラーメッセージが表示される
  - エラー時は設定したユーザーにメンション付きで通知が送信される
  - Slackチャンネルでエラー通知メッセージが受信される
  - システムが異常終了せず、エラー状態から回復可能
  - エラーログが適切に記録される
  - ユーザーに分かりやすいエラー説明が提供される
- **バックエンド処理確認**：
  - エラー発生時でも重複排除・翻訳・要約処理が継続される
  - 部分的に成功した処理結果が適切に保持される
  - エラー後の再実行で正常に処理が完了する

---

### シナリオ6: システム稼働確認

#### **前提条件**
- 全シナリオが正常に完了している

#### **テスト手順**
1. **システム状態確認**
   - Web管理画面の稼働状況を確認
   - データベース接続状況を確認
   - 外部API接続状況を確認

2. **パフォーマンス確認**
   - 各操作のレスポンス時間を測定
   - 同時接続時の動作確認

#### **期待結果**
- **システム稼働確認**：
  - システムが正常に稼働している
  - レスポンス時間が要件内（30秒以内）
  - 複数ユーザーでの同時アクセスが可能
  - データ保持期間は設定不要（問題発生まで放置）
- **バックエンド処理確認**：
  - 重複排除・翻訳・要約処理が安定して実行される
  - LLM処理が期待通りの品質で完了する
  - データベースの整合性が保たれている
  - パフォーマンスが要件を満たしている

---

## 3. テストデータ

### 3.1 テスト用企業データ（DOPA競合企業）
```json
{
  "companies": [
    {
      "name": "The Pokémon Company International",
      "urls": ["https://www.pokemon.com"],
      "rss_urls": ["https://www.pokemon.com/us/pokemon-news/rss/"]
    },
    {
      "name": "DeNA Co., Ltd.",
      "urls": ["https://dena.com"],
      "rss_urls": ["https://dena.com/intl/news/"]
    },
    {
      "name": "Niantic, Inc.",
      "urls": ["https://nianticlabs.com"],
      "rss_urls": ["https://nianticlabs.com/blog/"]
    }
  ]
}
```

### 3.2 テスト用ニュースデータ（DOPA競合関連）
```json
{
  "news_articles": [
    {
      "company_id": "pokemon_company",
      "title": "Pokemon TCG Live Platform Updates",
      "summary_jp": "ポケモン公式がTCG Liveプラットフォームの新機能を発表しました",
      "news_summary_jp": "【Pokemon】TCG Live新機能 - デジタルカード取引機能強化",
      "importance": 88,
      "url": "https://www.pokemon.com/us/pokemon-news/tcg-live-updates"
    },
    {
      "company_id": "dena_co",
      "title": "Pokemon Trading Card Game Pocket New Features",
      "summary_jp": "DeNAがポケポケアプリの新機能をリリースしました",
      "news_summary_jp": "【DeNA】ポケポケ新機能 - AR対戦とデジタルパック販売開始",
      "importance": 82,
      "url": "https://dena.com/intl/news/pokemon-pocket-update"
    },
    {
      "company_id": "niantic_inc",
      "title": "Pokemon GO Plus+ Integration with TCG",
      "summary_jp": "NianticがPokemon GO Plus+とTCGの連携機能を発表しました",
      "news_summary_jp": "【Niantic】Pokemon GO Plus+ TCG連携 - デジタルカード獲得機能",
      "importance": 75,
      "url": "https://nianticlabs.com/blog/pokemon-go-tcg-integration"
    }
  ]
}
```

## 4. テスト実行順序

1. **シナリオ1**: 企業登録・基本設定（企業登録 + コンテキスト設定 + Slackチャンネル設定）
2. **シナリオ2**: テスト実行機能（情報取得 + 日次レポート + 週次レポート）
3. **シナリオ3**: 日次レポート配信確認
4. **シナリオ4**: 週次レポート配信確認
5. **シナリオ5**: エラーハンドリング（詳細なエラーケース）
6. **シナリオ6**: システム稼働確認

## 5. 成功基準

### 5.1 機能要件
- 全シナリオが正常に完了する
- エラー時は適切にハンドリングされる
- Slack配信が正常に実行される

### 5.2 非機能要件
- レスポンス時間: 各操作が30秒以内
- データ保持: 設定不要（問題発生まで放置）
- セキュリティ: API キーが管理画面に露出されない
- エラー処理: 適切なエラーメッセージと通知

---

**作成日**: 2024年1月15日  
**バージョン**: 1.0  
**用途**: Playwright E2Eテストシナリオ
